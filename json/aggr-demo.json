{
    "name": "aggr-demo-api",
    "config": {
        "type": "REQUEST",
        "method": "POST",
        "path": "/aggr-demo/hotel/rates",
        "headersDef": {
            "type":"object",
            "properties":{
                "app-id":{
                    "type":"string",
                    "title":"应用ID",
                    "description":"应用唯一标识"
                },
                "timestamp":{
                    "type":"integer",
                    "title":"时间",
                    "description":"当前时间，例如1540281144468，跟系统相差不超过10分钟"
                },
                "sign":{
                    "type":"string",
                    "title":"签名",
                    "description":"签名，生成方式 Token = DigestUtils.sha256Hex((appId + \"-\" + timestamp + '-' + key).getBytes(Charset.forName(“UTF-8”)));"
                }
            },
            "required": ["app-id", "timestamp", "sign"]
        },
        "paramsDef": {
            "type":"object",
            "properties":{
                "lang":{
                    "type":"string",
                    "title":"语言",
                    "description":"描述"
                }
            }
        },
        "bodyDef": {
            "type":"object",
            "properties":{
                "userId":{
                    "type":"string",
                    "title":"用户名",
                    "description":"描述"
                }
            },
            "required": ["userId"]
        },
        "scriptValidate": {
            "type": "groovy",
            "source": "import org.apache.commons.codec.digest.DigestUtils; import java.nio.charset.StandardCharsets; import java.util.List; import java.util.ArrayList; String trueSign = DigestUtils.sha256Hex((variables.get(\"app-id\") + \"-\" + variables.get(\"input-timestamp\") + '-' + variables.get(\"key\")).getBytes(StandardCharsets.UTF_8));  if (trueSign.equals(variables.get(\"input-sign\"))) {return null;} else {List<String> errorList = new ArrayList<>(1); errorList.add(\"验签失败\"); return errorList;}",
            "variables": {
                "app-id": "a9d1526d-e50b-42bf-8e86-ce978cdd1e99",
                "key": "a3b93780-d517-4a7e-9b87-9236e052be6f",
                "input-app-id": "input input.request.headers.app-id",
                "input-timestamp": "input input.request.headers.timestamp",
                "input-sign": "input input.request.headers.sign"
            }
        },
        "validateResponse":{
            "fixedBody": {
                "code": -411
            },
            "fixedHeaders": {
                "a":"b"
            },
            "headers": {
            },
            "body": {
                "msg": "validateMsg"
            }
        },
        "dataMapping": {
            "response": {
           		"headers": {
                    "traceId": "step1.requests.request1.response.body.hello"
                },
                "body": {
                    "aaa": "step1.result",
                    "bbb": "step1.requests.request1.response.body.hello",
                    "ccc": "step2.requests.request3.response.body.hello",
                    "step2_request2_response": "step2.requests.request2.response.body"
                }
            }
        },
        "stepConfigs": [{
            "name": "step1",
            "stop": false,
            "dataMapping": {
                "response": {
                    "body": {
                        "rates": "step1.requests.request1.response.body.hello",
                        "roomTypes": "step1.requests.request1.response.body.user"
                    }
                }
            },
            "requests": {
                "request1": {
                    "type": "REQUEST",
                    "config": {
                        "url": "http://localhost:8080/delay?a=cccc&eeee=4444&seconds=1",
                        "method": "GET",
                        "connectTimeout": 1,
                        "readTimeout": 2,
                        "writeTimeout": 2,
                        "fallbackPlan": {
                            "mode": "continue",
                            "fallbackResult": "{\"user\":\"xxxxxxyyyyyyyyyyyyxx\"}"
                        },
                        "dataMapping": {
                            "request": {
		                        "fixedHeaders": {
		                            "a": "b"
		                        },
		                        "fixedParams": {
		                            "a": "b"
		                        },
		                        "fixedBody": {
		
		                        },
                                "headers": {
                                    "abc": "step1.requests.request1.headers.xyz"
                                },
                                "body": {
                                    "inn.innId": "step1.requests.request1.response.id"
                                },
                                "params": {
                                    "bbb": "input.request.body.userId"
                                }
                            },
                            "response": {
                                "headers": {
                                    "abc": "step1.requests.request1.headers.xyz"
                                },
                                "body": {
                                    "inn.innId": "step1.requests.request1.response.id"
                                },
	                            "script": {
	                            	"type": "groovy",
	                            	"source": "",
	                             	"variables": {
	                             		"appid": "1140",
	                             		"token": "859EE0413BC3F88F1F89C162800FB056"
									}
	                            }
                            }
                        }
                    }
                },
                "request2": {
                    "type": "REQUEST",
                    "config": {
                        "url": "http://localhost:8080/json",
                        "method": "GET",
                        "dataMapping": {
                            "request": {
                            	"fixedHeaders": {
		                            "a": "b"
		                        },
		                        "fixedParams": {
		                            "a": "b"
		                        },
		                        "fixedBody": {
		
		                        },
                                "headers": {
                                    "abc": "step1.requests.request1.headers.xyz"
                                },
                                "body": {
                                    "inn.innId": "step1.requests.request1.response.id"
                                },
                                "params": {
                                    "userId": "input.requestBody.userId"
                                }
                            },
                            "response": {
                                "headers": {
                                    "abc": "step1.requests.request1.headers.xyz"
                                },
                                "body": {
                                    "inn.innId": "step1.requests.request1.response.id"
                                }
                            }
                        }
                    }
                }
            }
        },
        {
            "name": "step2",
            "stop": false,
            "dataMapping": {
                "response": {
                    "body": {
                        
                    }
                }
            },
            "requests": {
                "request1": {
                    "type": "REQUEST",
                    "config": {
                        "url": "http://localhost:8080/json",
                        "method": "GET",
                        "dataMapping": {
                            "request": {
                            	"fixedHeaders": {
		                            "a": "b"
		                        },
		                        "fixedParams": {
		                            "a": "b"
		                        },
		                        "fixedBody": {
		
		                        },
                                "headers": {
                                    "abc": "step1.requests.request1.headers.xyz"
                                },
                                "body": {
                                    "abc.requestBody22": "step1.requests.request1.response.body"
                                },
                                "params": {
                                    "userId": "input.requestBody.userId"
                                }
                            },
                            "response": {
                                "headers": {
                                    "abc": "step1.requests.request1.headers.xyz"
                                },
                                "body": {
                                    "inn.innId": "step1.requests.request1.response.id"
                                }
                            }
                        }
                    }
                },
                "request2": {
                    "type": "REQUEST",
                    "config": {
                        "url": "http://localhost:8080/json",
                        "method": "GET",
                        "condition": {
                            "type": "groovy",
                            "source": "return \"ABC\".equals(variables.get(\"param1\")) && variables.get(\"param2\") >= 10;",
                            "variables": {
                                "param1": "input step1.requests.request2.response.body.user",
                                "param2": 10
                            }
                        },
                        "dataMapping": {
                            "request": {
                            	"fixedHeaders": {
		                            "a": "b"
		                        },
		                        "fixedParams": {
		                            "a": "b"
		                        },
		                        "fixedBody": {
		
		                        },
                                "headers": {
                                    "abc": "step1.requests.request1.headers.xyz"
                                },
                                "body": {
                                    "abc.requestBody22": "step1.requests.request1.response.body"
                                },
                                "params": {
                                    "userId": "input.requestBody.userId"
                                }
                            },
                            "response": {
                                "headers": {
                                    "abc": "step1.requests.request1.headers.xyz"
                                },
                                "body": {
                                    "inn.innId": "step1.requests.request1.response.id"
                                }
                            }
                        }
                    }
                }
            }
        }]
    }
}